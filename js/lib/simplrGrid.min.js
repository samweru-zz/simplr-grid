/*
 * jQuery simplrGrid - v1.0.0-alpha1
 * Javascript DataGrid
 *
 * Copyright (c) 2016 Samuel Weru
 * Released under the MIT license
 */
!function(a){a.fn.resizeHeader=function(){return this.each(function(){var d,e,b=!1,c=void 0;a(this).find("th span").mousedown(function(f){c=a(this).parent(),b=!0,d=f.pageX,e=c.width()}),a(document).mousemove(function(f){b&&a(c).width(e+(f.pageX-d))}),a(document).mouseup(function(){b&&(b=!1)})})},a.fn.fixHeader=function(){function c(a){var b=a.parent();b.append(a),b.css({"overflow-x":"auto","overflow-y":"auto"}),b.scroll(function(){var a=b.scrollTop();this.find("thead tr > *").css("top",a)}.bind(a))}function d(a){var b=a.find("thead"),d=(b.find("tr"),b.find("tr > *"));d.css({position:"relative"})}return this.each(function(){c(a(this)),d(a(this))})},a.fn.fixLeftColumn=function(){function c(a){var c=a.parent();c.append(a),c.css({"overflow-x":"auto","overflow-y":"auto"}),c.scroll(function(){var a=c.scrollLeft();b.left>0&&b.leftColumns.css("left",a)}.bind(a))}function d(c){b.leftColumns=a();var d=c.find("tr");d.each(function(a,c){e(c,function(a){b.leftColumns=b.leftColumns.add(a)})});var f=b.leftColumns;f.each(function(b,c){var c=a(c);c.css({position:"relative"})})}function e(c,d){for(var e=b.left,f=1,g=1;g<=e;g+=f){var h=f>1?g-1:g,i=a(c).find("> *:nth-child("+h+")"),j=i.prop("colspan");d(i),f=j}}var b={left:1};return this.each(function(){c(a(this)),d(a(this)),a(this).parent().trigger("scroll"),a(window).resize(function(){a(this).parent().trigger("scroll")})})},a.fn.getSelected=function(){var b=a(this).find("tr.selected:first td"),c={};return a.each(b,function(b,d){var e=a(d).attr("field");e&&(c[e]=a(d).find("div").html())}),c},a.fn.getAllSelected=function(){var b=[];return a.each(a(this).find("tr.selected"),function(c,d){var e={};a.each(a(d).find("td"),function(b,c){var d=a(c).attr("field");d&&(e[d]=a(c).find("div").html())}),b.push(e)}),b},a.fn.simplrGrid=function(b){function e(b,c){b.addClass("simplr-grid");var d=a(document.createElement("THEAD")),e=a(document.createElement("TR"));d.append(e),b.append(d),IdCellTh=a(document.createElement("TH")),e.append(IdCellTh);var f=Object.keys(c.data[0]);a.each(f,function(b,d){var f=a(document.createElement("TH"));f.append(d[0].toUpperCase()+d.substring(1)),c.resizeColumns&&f.append(a("<span>&nbsp;</span>")),a.inArray(d,c.columnHide)!=-1&&f.hide(),e.append(f)})}function f(b,c){var d=a(document.createElement("TBODY"));b.append(d);var e=parseInt(c.pager.page),f=parseInt(c.pager.rows),g=(e-1)*f+1;a.each(c.data,function(b,e){var f=a(document.createElement("TR"));c.onDblClick&&f.dblclick(function(b){var d=a(b.currentTarget).find("td"),e={};a.each(d,function(b,c){var d=a(c).attr("field");d&&(e[d]=a(c).find("div").html())}),c.onDblClick(e)}),d.append(f),f.click(function(b){c.singleSelect&&a(b.currentTarget).parent().find("tr.selected").removeClass("selected"),a(b.currentTarget).hasClass("selected")?a(b.currentTarget).removeClass("selected"):a(b.currentTarget).addClass("selected")});var h=0;a.each(e,function(b,d){if(0==h){var e=a(document.createElement("TD"));e.css({textAlign:"right",fontWeight:"bold"}),e.html(g++),f.append(e)}var i=a(document.createElement("TD"));f.append(i),i.attr("field",b),a.inArray(b,c.columnHide)!=-1&&i.hide(),i.html(a(document.createElement("DIV")).html(d)),h++})}),b.css({minWidth:"1000px"})}function g(a,b){var c=parseInt(a),d=parseInt(b),e=Math.ceil(c/d);return e}var c={title:"Simplr Grid",columnHide:[],toolbars:[],pager:{page:1,rows:50,list:[50,40,30,20,10]},css:{},data:[],method:"POST",singleSelect:!0,resizeColumns:!0,freezeLeftColumn:!0,freezeHeader:!0,usePager:!1};b.pager=a.extend({},c.pager,b.pager);var d=a.extend({__initGrid:!0},c,b),h=function(a){this.options=a};return h.prototype={constructor:h,addToolbar:function(b){var c=a(document.createElement("DIV"));return c.addClass("simplr-grid-toolbar"),a.each(b,function(a,b){c.append(b)}),c},_reTblEl:function(a){return this.options.__initGrid=!1,a.find(".simplr-grid tbody").remove(),a.find(".simplr-grid")},_cfgPager:function(b){this.options.pager=a.extend(this.options.pager,b)},_calcPages:function(){return g(this.options.pager.count,this.options.pager.rows)},pager:function(b){var c=this,d=a(document.createElement("INPUT"));d.val(this.options.pager.page),d.addClass("page-num").attr("size",2);var e=a(document.createElement("SELECT"));a.each(this.options.pager.list,function(b,c){a(e).append(new Option(c))}),a(e).val(this.options.pager.rows),e.change(function(){var e=1;c._cfgPager({page:e,rows:parseInt(a(this).val())}),d.val(e),c.getData(c._reTblEl(b))});var f=a(document.createElement("BUTTON")).html("|<");f.click(function(){c.options.pager.page>1&&(c.options.pager.page=1,d.val(c.options.pager.page),c.getData(c._reTblEl(b)))});var g=a(document.createElement("BUTTON")).html("<");g.click(function(){c.options.pager.page>1&&(c.options.pager.page--,d.val(c.options.pager.page),c.getData(c._reTblEl(b)))});var h=a(document.createElement("BUTTON")).html(">");h.click(function(){var a=c._calcPages(),e=parseInt(c.options.pager.page);e<a&&(c.options.pager.page++,d.val(c.options.pager.page),c.getData(c._reTblEl(b)))});var i=a(document.createElement("BUTTON")).html(">|");i.click(function(){var a=c._calcPages(),e=parseInt(c.options.pager.page);e<a&&(c.options.pager.page=a,d.val(a),c.getData(c._reTblEl(b)))});var j=a(document.createElement("BUTTON")).html("Refresh");j.click(function(){var a=c._calcPages(),e=d.val(),f=1;isNaN(e)||(f=parseInt(e)),f>a&&(f=a),e!=f&&d.val(f),c._cfgPager({page:f}),c.getData(c._reTblEl(b))});var k="&nbsp;|&nbsp;",l=a(document.createElement("SPAN"));return l.addClass("num-of-pages"),this.addToolbar([e,k,f,g," Page ",d," of ",l,"&nbsp;",h,i,k,j])},createTitle:function(){var b=a(document.createElement("DIV"));return b.addClass("simplr-grid-title"),b.html("&nbsp;".concat(this.options.title)),b},createCapsule:function(){var b=a(document.createElement("DIV"));b.addClass("simplr-grid-capsule");var c=a(document.createElement("DIV"));return c.addClass("simplr-grid-body"),b.css({width:this.options.css.width}),c.css({height:this.options.css.height}),b.append(c),b},getData:function(b){var c=this;this.options.url?a.ajax({url:this.options.url,method:this.options.method,data:{page:this.options.pager.page,rows:this.options.pager.rows}}).done(function(a){c.options.data=a.rows,c._cfgPager({count:a.count}),c.options.__initGrid&&e(b,c.options),f(b,c.options);var d=c._calcPages();b.parent().parent().find(".num-of-pages").html(d),c.enableAddOns(b)}).fail(function(){console.log("Ajax Error!")}):this.options.data&&(this.options.__initGrid&&e(b,this.options),f(b,this.options))},enableAddOns:function(a){this.options.__initGrid?(this.options.freezeLeftColumn&&a.fixLeftColumn(),this.options.freezeHeader&&a.fixHeader(),this.options.resizeColumns&&a.resizeHeader()):a.fixLeftColumn()}},this.each(function(){var b=new h(d),c=b.createCapsule();b.getData(a(this)),a(this).wrap(c);var e=a(this).parent();e.before(b.createTitle()),a.each(d.toolbars,function(a,c){e.before(b.addToolbar(c))}),d.usePager&&e.before(b.pager(e))})}}(jQuery);