/*
 * jQuery simplrGrid - v1.0.0
 * Javascript DataGrid
 *
 * Copyright (c) 2019 Samuel Weru
 * Released under the MIT license
 */
!function(e){class t{addRow(t,a,n){var s=e(document.createElement("TR")),r=e(document.createElement("TD"));return s.append(r.html(t)),n.dblClick&&s.dblclick(n.dblClick),s.click((function(){n.singleSelect?e(this).addClass("selected").siblings().removeClass("selected"):e(this).hasClass("selected")?e(this).removeClass("selected"):e(this).addClass("selected")})),e.each(a,(function(t,a){var o={};if(!e.isEmptyObject(n.columns)){var l=n.columns[t];void 0!==l&&l.hasOwnProperty("css")&&(o=l.css||o)}r=e(document.createElement("TD")).attr("name",t).css(o),n.resizeColumns?r.html(e(document.createElement("DIV")).html(a)):r.html(a),s.append(r)})),s}buildBody(a,n,s){var r=(parseInt(s.pager.page)-1)*parseInt(s.pager.rows)+1,o=e(document.createElement("TBODY"));for(idx in n)o.append(t.prototype.addRow.apply(this,[r++,n[idx],s]));a.append(o)}buildHeader(t,a,n){var s=e(document.createElement("THEAD")),r=e(document.createElement("TH"));return s.append(r.html("&nbsp;")),e.each(a[0],(function(t,a){var r={},o="";if(!e.isEmptyObject(n.columns)&&n.columns.hasOwnProperty(t)){var l=n.columns[t];o=l.name||t,l.hasOwnProperty("css")&&l.css.hasOwnProperty("display")&&"none"==l.css.display.toLowerCase().trim()&&(r={display:"none"})}if(!o){var p=t.split("_");o=p.length>1?p.map((function(e){return e[0].toUpperCase()+e.substring(1)})).join(" "):t[0].toUpperCase()+t.substring(1)}s.append(e(document.createElement("TH")).attr("name",t).html(o).css(r))})),a.length>0&&(t.append(s),!0)}addToolbar(t){var a=e(document.createElement("DIV"));return a.addClass("simplr-grid-toolbar"),e.each(t,(function(e,t){a.append(t)})),a}buildPager(a,n){var s=e(document.createElement("INPUT"));s.val(n.pager.page),s.addClass("page-num").attr("size",2);var r=e(document.createElement("SELECT"));e.each(n.pager.list,(function(t,a){e(r).append(new Option(a))}));var o=this,l=t.prototype.loader,p=t.prototype.rebuildBody;r.change((function(){n.pager.page=1,n.pager.rows=e(this).val(),s.val(n.pager.page),l.apply(o,[a,n,p])}));var i=e(document.createElement("BUTTON")).addClass("sg-first").html("&#171;").attr("title","First");i.click((function(){1!=n.pager.page&&(n.pager.page=1,s.val(n.pager.page),l.apply(o,[a,n,p]))}));var d=e(document.createElement("BUTTON")).addClass("sg-prev").html("&#8249;").attr("title","Previous");d.click((function(){n.pager.page>1&&(n.pager.page--,s.val(n.pager.page),l.apply(o,[a,n,p]))}));var c=e(document.createElement("BUTTON")).addClass("sg-next").html("&#8250;").attr("title","Next");c.click((function(){n.pager.page<n.pager.pages&&(n.pager.page++,s.val(n.pager.page),l.apply(o,[a,n,p]))}));var u=e(document.createElement("BUTTON")).addClass("sg-last").html("&#187;").attr("title","Last");u.click((function(){n.pager.page!=n.pager.pages&&(n.pager.page=n.pager.pages,s.val(n.pager.page),l.apply(o,[a,n,p]))}));var h=e(document.createElement("BUTTON")).addClass("sg-refresh").html("&#8634;").attr("title","Refresh");h.click((function(){n.pager.page=a.parent().parent().find(".page-num").val(),l.apply(o,[a,n,p])}));var m="&nbsp;|&nbsp;",g=e(document.createElement("SPAN"));return g.addClass("num-of-pages"),g.html(n.pager.pages),t.prototype.addToolbar.apply(this,[[r,m,i,d,"<span> Page </span>",s,"<span> of </span>",g,"<span>&nbsp;</span>",c,u,m,h]])}buildToolbars(a,n,s){var r=e(document.createElement("DIV"));r.addClass("simplr-grid-capsule"),r.css({width:s.css.capsuleWidth}),a.css({width:s.css.gridWidth});var o=this,l=t.prototype.rebuildBody,p=t.prototype.loader,i=t.prototype.addToolbar,d=t.prototype.buildPager,c=a.data("options");a.replaceWith(r),a.data("options",c),a.bind("refresh",(function(t,n){console.log(n);n=e.extend(a.data("options"),n);p(a,n,l)}));var u=e(document.createElement("DIV"));u.addClass("simplr-grid-title"),u.html("&nbsp;".concat(s.title));var h=e(document.createElement("DIV"));h.addClass("simplr-grid-inner"),h.css({height:s.css.gridHeight}),r.append(u),e.each(s.toolbars,(function(e,t){r.append(i.apply(o,[t]))})),s.usePager&&r.append(d(a,s)),r.append(h),h.append(a)}disableToolbar(t,a){var n=t.parent().prev();if(n.find(".sg-last, .sg-next, .sg-prev, .sg-first, .page-num, select").attr("disabled",a),a){var s=e("<div>").addClass("msg-outer"),r=e("<div>").addClass("msg-inner").html("No Data");t.parent().not(":has(.msg-outer)").append(s.append(r)),n.find(".num-of-pages").html("#")}else t.parent().find(".msg-outer").remove()}build(e,a,n){t.prototype.buildToolbars.apply(this,[e,a,n]),a.rows.length>0?(t.prototype.buildHeader.apply(this,[e,a.rows,n]),t.prototype.buildBody.apply(this,[e,a.rows,n]),t.prototype.doPlugins.apply(this,[e,n]),t.prototype.disableToolbar.apply(this,[e,!1])):t.prototype.disableToolbar.apply(this,[e,!0])}rebuildBody(e,a,n){e.find("thead").remove(),e.find("tbody").remove(),setTimeout((function(){a.rows.length>0?(t.prototype.buildHeader.apply(this,[e,a.rows,n]),t.prototype.buildBody.apply(this,[e,a.rows,n]),t.prototype.doPlugins.apply(this,[e,n]),e.parent().parent().find(".num-of-pages").html(n.pager.pages),t.prototype.disableToolbar.apply(this,[e,!1])):t.prototype.disableToolbar.apply(this,[e,!0])}),100)}doPlugins(e,t){t.fixHeader&&e.fixHeader(),t.fixLeftColumn?e.fixLeftColumn():e.parent().css({overflow:"auto"}),t.resizeColumns&&e.resizeColumns()}nativeLoader(t,a,n){e.ajax({type:a.method,dataType:"json",url:a.url,data:{page:a.pager.page,rows:a.pager.rows}}).done((function(e){a.pager.pages=Math.ceil(e.count/a.pager.rows),n(t,e,a)}))}loader(e,t,a){e.addClass("simplr-grid"),t.data.length>0?(a.apply(this,[e,{rows:t.data,count:t.data.length},t]),this.doPlugins(e,t)):t.customLoader?t.customLoader(e,t,a):this.nativeLoader(e,t,a)}}e.fn.simplrGrid=function(a){return a=e.extend(!0,{},{title:"Simplr Grid",toolbars:[],columns:{},pager:{page:1,rows:10,list:[50,40,30,20,10]},css:{},data:[],method:"POST",singleSelect:!0,dblClick:null,customLoader:null,usePager:!1,fixHeader:!1,fixLeftColumn:!1,resizeColumns:!1},a),this.data("options",a),this.each((function(){var n=new t;n.loader(e(this),a,n.build)}))},e.fn.getRow=function(t){var a={};return e(this).has("td").find("td:not(:first-child)").each((function(t,n){var s=e(n).attr("name");e(this).has("div").length?val=e(this).find("div").html():val=e(this).html(),a[s]=val})),a},e.fn.getSelectedRow=function(){return e(this).find("tr.selected:first").getRow()},e.fn.getSelectedRows=function(){var t=[];return e.each(e(this).find("tr.selected"),(function(a,n){t.push(e(n).getRow())})),t},e.fn.fixHeader=function(){return this.each((function(){var t,a;t=e(this),(a=t.parent()).append(t),a.css({"overflow-x":"auto","overflow-y":"auto"}),a.scroll(function(){var t=a.scrollTop();e(this).find("thead > *").css("top",t)}.bind(t)),function(e){e.find("thead > *").css({position:"relative"})}(e(this))}))},e.fn.fixLeftColumn=function(){var t={left:1};return this.each((function(){var a,n;a=e(this),(n=a.parent()).append(a),n.css({"overflow-x":"auto","overflow-y":"auto"}),n.scroll(function(){var e=n.scrollLeft();t.left>0&&t.leftColumns.css("left",e)}.bind(a)),function(a){t.leftColumns=e(),a.find("tr").each((function(a,n){!function(a,n){for(var s=t.left,r=1,o=1;o<=s;o+=r){var l=r>1?o-1:o,p=e(a).find("> *:nth-child("+l+")"),i=p.prop("colspan");n(p),r=i}}(n,(function(e){t.leftColumns=t.leftColumns.add(e)}))})),t.leftColumns.each((function(t,a){(a=e(a)).css({position:"relative"})}))}(e(this)),e(this).parent().trigger("scroll"),e(window).resize((function(){e(this).parent().trigger("scroll")}))}))},e.fn.resizeColumns=function(){return this.each((function(){var t,a,n=!1,s=void 0;0==e(this).find("th:last-child").has("span").length&&e(this).find("th:not(:first-child)").append("<span>&nbsp;</span>"),e(this).find("th span").mousedown((function(r){s=e(this).parent(),n=!0,t=r.pageX,a=s.width()})),e(document).mousemove((function(r){n&&e(s).width(a+(r.pageX-t))})),e(document).mouseup((function(){n&&(n=!1)}))}))}}(jQuery);